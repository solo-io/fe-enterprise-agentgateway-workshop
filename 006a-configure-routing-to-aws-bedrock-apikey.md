# Configure Routing to AWS Bedrock Provider (Using short/long term API Keys)

## Pre-requisites
This lab assumes that you have completed the setup in `001`, and `002`

## Lab Objectives
- Configure `AmazonBedrockLimitedAccess` IAM permission for AWS Bedrock access (required for short-term API keys)
- Generate an AWS Bedrock API key (short-term or long-term)
- Create a Kubernetes secret that contains the API key as a Bearer token
- Create a route to AWS Bedrock as our backend LLM provider using an `AgentgatewayBackend` and `HTTPRoute`
- Curl AWS Bedrock through the agentgateway proxy
- Validate the request went through the gateway in the Grafana UI

## Overview
This lab demonstrates configuring AWS Bedrock authentication using API keys instead of AWS credentials. AWS Bedrock offers two types of API keys [also see AWS doc](https://docs.aws.amazon.com/bedrock/latest/userguide/api-keys-how.html):

**Short-term key â€“ A secure option that allows temporary access to using Amazon Bedrock**:
- Valid for the shorter of the following values:
  - 12 hours
  - The duration of the session generated by the IAM principal used to generate the key
- Inherit the permissions attached to the principal used to generate the key
- Can be used only in the AWS Region from which you generated it.
- Can only be generated in the AWS console
- **Require** the IAM user/role to have Bedrock permissions (e.g., `AmazonBedrockLimitedAccess` policy)

**Long-term API Keys**:
- Recommended only for exploration of Amazon Bedrock. You can set the time after which the key expires. When you generate a long-term key, it underlyingly creates an IAM user that's for you, attaches the IAM policies that you select, and associates the key with the user. After you generate the key, you can use the IAM service to modify permissions for the IAM user.

**Important**: To use short-term API keys, you must first attach the `AmazonBedrockLimitedAccess` (or equivalent) IAM policy to your IAM user or role. This is required for the API key to have permission to call Bedrock services. See [AWS documentation on AmazonBedrockLimitedAccess Policy](https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonBedrockLimitedAccess.html) for more on policy details

## Configure IAM Permissions (Required for Short-term API Keys)

Before generating a short-term API key, you need to attach the `AmazonBedrockLimitedAccess` policy to your IAM user or role. Long-term API keys automatically receive this policy, but short-term keys inherit the permissions of the IAM principal generating them.

### Add the Policy Using AWS Console

1. Navigate to the [IAM Console](https://console.aws.amazon.com/iam/)
2. In the left navigation pane, choose **Users** (or **Roles** if using a role)
3. Select your IAM user (or role) from the list
4. Click the **Permissions** tab
5. Click **Add permissions** > **Attach policies directly**
6. In the search box, type `AmazonBedrockLimitedAccess`
7. Check the box next to **AmazonBedrockLimitedAccess**
8. Click **Next**
9. Click **Add permissions** to confirm

### Verify the Policy is Attached

After attaching the policy, you should see `AmazonBedrockLimitedAccess` listed under the **Permissions policies** section of your IAM user or role.

The `AmazonBedrockLimitedAccess` policy grants access to core Amazon Bedrock API operations including:
- `bedrock:InvokeModel`
- `bedrock:InvokeModelWithResponseStream`
- `bedrock:ListFoundationModels`
- And other essential Bedrock operations

## Generate AWS Bedrock API Key

You can generate either a short-term (up to 12 hours) or long-term (up to 36600 days) AWS Bedrock API key using the AWS Console.

### Using AWS Console

1. Navigate to the [Amazon Bedrock console](https://console.aws.amazon.com/bedrock/)
2. In the left navigation pane, choose **API keys**
3. Choose **Generate API key**
4. Select the API key type:
   - **Short-term**: Valid for up to 12 hours. Inherits your IAM permissions (requires `AmazonBedrockLimitedAccess` policy configured in the previous step)
   - **Long-term**: Valid for 1-36600 days. Automatically receives the `AmazonBedrockLimitedAccess` policy
5. If using long-term, configure the expiration period (optional)
6. Copy the generated API key
   - **Important**: Save this key securely as you won't be able to retrieve it again

## Short-term vs. Long-term key structure
- Short-term keys start with a prefix - `bedrock-api-key-<restofkey>` and can only be generated in the AWS console
- Long-term keys are just a random string, no prefix

## Export AWS Bedrock API Key
Export the API key as an environment variable:
```bash
export BEDROCK_API_KEY="<your-api-key-here>"
```

Verify the variable was exported:
```bash
echo $BEDROCK_API_KEY
```

## Create Kubernetes Secret
Create a secret containing the API key in the format expected by the AgentGateway. The secret must contain an `Authorization` key with the value in Bearer token format:

```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: bedrock-apikey-secret
  namespace: agentgateway-system
type: Opaque
stringData:
  Authorization: "Bearer ${BEDROCK_API_KEY}"
EOF
```

## Create AWS Bedrock Route and AgentgatewayBackends
Create AWS Bedrock route and `AgentgatewayBackend` resources. For this setup we will configure multiple `AgentgatewayBackends` using a single provider (AWS Bedrock) in a path-per-model routing configuration.

Note the key difference from lab 006: we use `spec.policies.auth.secretRef` instead of `spec.policies.auth.aws` for API key authentication.

```bash
kubectl apply -f - <<EOF
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: bedrock-mistral-apikey
  namespace: agentgateway-system
spec:
  ai:
    provider:
      bedrock:
        model: mistral.voxtral-mini-3b-2507
        region: us-west-2
  policies:
    auth:
      secretRef:
        name: bedrock-apikey-secret
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: bedrock-haiku3.5-apikey
  namespace: agentgateway-system
spec:
  ai:
    provider:
      bedrock:
        model: anthropic.claude-3-5-haiku-20241022-v1:0
        region: us-west-2
  policies:
    auth:
      secretRef:
        name: bedrock-apikey-secret
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: bedrock-llama3-8b-apikey
  namespace: agentgateway-system
spec:
  ai:
    provider:
      bedrock:
        model: meta.llama3-1-8b-instruct-v1:0
        region: us-west-2
  policies:
    auth:
      secretRef:
        name: bedrock-apikey-secret
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bedrock-apikey
  namespace: agentgateway-system
  labels:
    example: bedrock-apikey-route
spec:
  parentRefs:
    - name: agentgateway-proxy
      namespace: agentgateway-system
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /bedrock-apikey/haiku
      backendRefs:
        - name: bedrock-haiku3.5-apikey
          group: agentgateway.dev
          kind: AgentgatewayBackend
      timeouts:
        request: "120s"
    - matches:
        - path:
            type: PathPrefix
            value: /bedrock-apikey/mistral
      backendRefs:
        - name: bedrock-mistral-apikey
          group: agentgateway.dev
          kind: AgentgatewayBackend
      timeouts:
        request: "120s"
    - matches:
        - path:
            type: PathPrefix
            value: /bedrock-apikey/llama3-8b
      backendRefs:
        - name: bedrock-llama3-8b-apikey
          group: agentgateway.dev
          kind: AgentgatewayBackend
      timeouts:
        request: "120s"
    # catch-all will route to the bedrock mistral upstream
    - matches:
        - path:
            type: Exact
            value: /bedrock-apikey
      backendRefs:
        - name: bedrock-mistral-apikey
          group: agentgateway.dev
          kind: AgentgatewayBackend
      timeouts:
        request: "120s"
EOF
```

## Test the Configuration

### curl AWS Bedrock Mistral endpoint
```bash
export GATEWAY_IP=$(kubectl get svc -n agentgateway-system --selector=gateway.networking.k8s.io/gateway-name=agentgateway-proxy -o jsonpath='{.items[*].status.loadBalancer.ingress[0].ip}{.items[*].status.loadBalancer.ingress[0].hostname}')

curl -i "$GATEWAY_IP:8080/bedrock-apikey/mistral" \
  -H "content-type: application/json" \
  -d '{
    "model": "",
    "messages": [
      {
        "role": "user",
        "content": "Whats your favorite poem?"
      }
    ]
  }'
```

### curl AWS Bedrock Haiku endpoint
```bash
curl -i "$GATEWAY_IP:8080/bedrock-apikey/haiku" \
  -H "content-type: application/json" \
  -d '{
    "model": "",
    "messages": [
      {
        "role": "user",
        "content": "Whats your favorite poem?"
      }
    ]
  }'
```

### curl AWS Bedrock llama3-8b endpoint
```bash
curl -i "$GATEWAY_IP:8080/bedrock-apikey/llama3-8b" \
  -H "content-type: application/json" \
  -d '{
    "model": "",
    "messages": [
      {
        "role": "user",
        "content": "Whats your favorite poem?"
      }
    ]
  }'
```

## Observability

### View Metrics Endpoint

AgentGateway exposes Prometheus-compatible metrics at the `/metrics` endpoint. You can curl this endpoint directly:

```bash
kubectl port-forward -n agentgateway-system deployment/agentgateway-proxy 15020:15020 & \
sleep 1 && curl -s http://localhost:15020/metrics && kill $!
```

### View Metrics and Traces in Grafana

For a comprehensive view of metrics and traces, use the AgentGateway Grafana dashboard installed in lab 002.

1. Port-forward to the Grafana service:
```bash
kubectl port-forward svc/grafana-prometheus -n monitoring 3000:3000
```

2. Open http://localhost:3000 in your browser

3. Login with credentials:
   - Username: `admin`
   - Password: Value of `$GRAFANA_ADMIN_PASSWORD` (default: `prom-operator`)

4. Navigate to **Dashboards > AgentGateway Dashboard** to view metrics

The dashboard provides real-time visualization of:
- Core GenAI metrics (request rates, token usage by model)
- Streaming metrics (TTFT, TPOT)
- MCP metrics (tool calls, server requests)
- Connection and runtime metrics

### View Traces in Grafana

To view distributed traces with LLM-specific spans:

1. In Grafana, navigate to **Home > Explore**
2. Select **Tempo** from the data source dropdown
3. Click **Search** to see all traces
4. Filter traces by service, operation, or trace ID to find AgentGateway requests

Traces include LLM-specific spans with information like `gen_ai.completion`, `gen_ai.prompt`, `llm.request.model`, `llm.request.tokens`, and more.

### View Access Logs

AgentGateway automatically logs detailed information about LLM requests to stdout:

```bash
kubectl logs deploy/agentgateway-proxy -n agentgateway-system --tail 1
```

Example output shows comprehensive request details including model information, token usage, and trace IDs for correlation with distributed traces in Grafana.

### (Optional) View Traces in Jaeger

If you installed Jaeger in lab `/install-on-openshift/002-set-up-monitoring-tools-ocp.md` instead of Tempo, you can view traces in the UI:

```bash
kubectl port-forward svc/jaeger -n observability 16686:16686
```

Navigate to http://localhost:16686 in your browser to see traces with LLM-specific spans including `gen_ai.completion`, `gen_ai.prompt`, `llm.request.model`, `llm.request.tokens`, and more

## Cleanup
```bash
kubectl delete httproute -n agentgateway-system bedrock-apikey
kubectl delete agentgatewaybackend -n agentgateway-system bedrock-mistral-apikey
kubectl delete agentgatewaybackend -n agentgateway-system bedrock-haiku3.5-apikey
kubectl delete agentgatewaybackend -n agentgateway-system bedrock-llama3-8b-apikey
kubectl delete secret -n agentgateway-system bedrock-apikey-secret
```